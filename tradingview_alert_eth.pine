//@version=5
// TradingView Alert for ETHUSDT - Webhook to Python Server
// 이더리움 1분 봉 마감 시 웹훅 전송

strategy("ETHUSDT Webhook Alert", overlay=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================
// 지표 설정
// ============================================

// EMA 설정
ema_fast = ta.ema(close, 20)
ema_mid = ta.ema(close, 40)
ema_slow = ta.ema(close, 80)

// 볼린저 밴드
bb_length = 20
bb_mult = 2.0
bb_basis = ta.sma(close, bb_length)
bb_dev = bb_mult * ta.stdev(close, bb_length)
bb_upper = bb_basis + bb_dev
bb_lower = bb_basis - bb_dev

// ATR
atr_length = 14
atr = ta.atr(atr_length)

// 거래량 이동평균
volume_ma = ta.sma(volume, 20)

// ============================================
// 레짐 탐지 (EMA 정렬)
// ============================================

// 강세장: fast > mid > slow
bull_regime = ema_fast > ema_mid and ema_mid > ema_slow

// 약세장: fast < mid < slow
bear_regime = ema_fast < ema_mid and ema_mid < ema_slow

// 횡보장: 그 외
sideways_regime = not bull_regime and not bear_regime

// 현재 레짐
current_regime = bull_regime ? "bull" : bear_regime ? "bear" : "sideways"

// ============================================
// 진입 조건
// ============================================

// Long 진입 조건
// 1. 강세장 레짐
// 2. 가격이 볼린저 밴드 하단 터치
// 3. 거래량이 평균 이상
long_condition = barstate.isconfirmed and bull_regime and close <= bb_lower and volume >= volume_ma * 0.5

// Short 진입 조건
// 1. 약세장 레짐
// 2. 가격이 볼린저 밴드 상단 터치
// 3. 거래량이 평균 이상
short_condition = barstate.isconfirmed and bear_regime and close >= bb_upper and volume >= volume_ma * 0.5

// ============================================
// 웹훅 전송
// ============================================

// Long 진입 시 웹훅 전송
if long_condition
    alert_message = '{"symbol": "ETHUSDT", "exchange": "BINANCE", "timeframe": "' + timeframe.period + '", "timestamp": "' + str.tostring(time) + '", "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "close": ' + str.tostring(close) + ', "volume": ' + str.tostring(volume) + ', "regime": "bull", "action": "buy", "ema_fast": ' + str.tostring(ema_fast) + ', "ema_mid": ' + str.tostring(ema_mid) + ', "ema_slow": ' + str.tostring(ema_slow) + ', "bb_upper": ' + str.tostring(bb_upper) + ', "bb_lower": ' + str.tostring(bb_lower) + ', "atr": ' + str.tostring(atr) + ', "volume_ma": ' + str.tostring(volume_ma) + '}'
    alert(alert_message, alert.freq_once_per_bar)

// Short 진입 시 웹훅 전송
if short_condition
    alert_message = '{"symbol": "ETHUSDT", "exchange": "BINANCE", "timeframe": "' + timeframe.period + '", "timestamp": "' + str.tostring(time) + '", "open": ' + str.tostring(open) + ', "high": ' + str.tostring(high) + ', "low": ' + str.tostring(low) + ', "close": ' + str.tostring(close) + ', "volume": ' + str.tostring(volume) + ', "regime": "bear", "action": "sell", "ema_fast": ' + str.tostring(ema_fast) + ', "ema_mid": ' + str.tostring(ema_mid) + ', "ema_slow": ' + str.tostring(ema_slow) + ', "bb_upper": ' + str.tostring(bb_upper) + ', "bb_lower": ' + str.tostring(bb_lower) + ', "atr": ' + str.tostring(atr) + ', "volume_ma": ' + str.tostring(volume_ma) + '}'
    alert(alert_message, alert.freq_once_per_bar)

// ============================================
// 차트 표시
// ============================================

// EMA 플롯
plot(ema_fast, "EMA Fast", color=color.blue, linewidth=1)
plot(ema_mid, "EMA Mid", color=color.orange, linewidth=1)
plot(ema_slow, "EMA Slow", color=color.red, linewidth=1)

// 볼린저 밴드 플롯
plot(bb_upper, "BB Upper", color=color.gray, linewidth=1)
plot(bb_lower, "BB Lower", color=color.gray, linewidth=1)
plot(bb_basis, "BB Basis", color=color.gray, linewidth=1, style=plot.style_line)

// 레짐 배경색
bgcolor(bull_regime ? color.new(color.green, 95) : bear_regime ? color.new(color.red, 95) : na)

// 진입 신호 표시
plotshape(long_condition, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.small, title="Long Signal")
plotshape(short_condition, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.small, title="Short Signal")


